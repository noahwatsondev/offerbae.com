<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OfferBae</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: <%=(typeof settings !=='undefined' && settings.defaultLinkColor) ? settings.defaultLinkColor: '#4f46e5' %>;
            --bg: <%=(typeof settings !=='undefined' && settings.bgColor) ? settings.bgColor: '#f9fafb' %>;
            --surface: #ffffff;
            --text-main: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .bg-fixed-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            pointer-events: none;
        }
    </style>
    <style>
        <%- include('partials/header-styles') %>
    </style>
    <style>
        h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            letter-spacing: -0.025em;
        }

        .container {
            width: 100%;
            /* max-width: 1280px; */
            margin: 0 auto;
            padding: 0;
            display: block;
        }

        main {
            position: relative;
            background: rgba(255, 255, 255, .8);
            padding: 1rem 5rem;
            /* border-radius: .75rem; */
            /* box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); */
            padding-bottom: 3rem;
            width: 100%;
            box-sizing: border-box;
            border-radius: 0;
        }

        @media (max-width: 768px) {
            main {
                padding: .5rem;
            }
        }

        /* Filter Section */
        .filter-section {
            padding: 1rem 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .category-links {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            justify-content: center;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            position: relative;
        }

        @media (max-width: 768px) {
            .category-links.collapsed {
                max-height: 110px;
                /* Adjust based on pill height approx 3 rows */
                overflow: hidden;
                -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
                mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            }
        }

        .category-expand-btn {
            display: none;
            margin: -0.5rem auto 1.5rem;
            background: #fff;
            border: 1px solid var(--border);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            color: var(--primary);
            font-weight: 400;
            font-size: 0.75rem;
            cursor: pointer;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .category-expand-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .category-expand-btn svg {
            transition: transform 0.3s;
        }

        @media (max-width: 768px) {
            .category-expand-btn {
                display: flex;
            }
        }

        .category-link {
            color: #dc2626;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.813rem;
            padding: 0.375rem 0.75rem;
            border-radius: 1rem;
            background-color: #f3f4f6;
            border: 1px solid transparent;
        }

        .category-link:hover {
            background-color: #e5e7eb;
            color: var(--text-main);
        }

        .category-link.active-category {
            color: white !important;
            background-color: var(--primary);
            /* border-color: var(--primary); */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #EF3E5C, #8b5cf6);
            color: white;
            <%- (typeof settings !=='undefined' && settings.categorySelectedStyles) ? settings.categorySelectedStyles: '' %>
        }

        .controls-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 640px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .search-wrapper,
            .sort-wrapper {
                width: 100%;
                min-width: 0 !important;
            }
        }

        .search-wrapper {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-wrapper input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            font-size: 0.938rem;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            color: var(--primary);
        }

        .search-wrapper input::placeholder {
            color: var(--primary);
            opacity: 1;
        }

        .search-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            pointer-events: none;
        }

        /* Global Search Results Dropdown */
        .global-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: #f9fafb;
        }

        .search-result-thumb {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: contain;
            background: #fff;
            border: 1px solid #eee;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-brand {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .pagination-controls.top {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .pagination-controls.bottom {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .sort-wrapper {
            min-width: 180px;
        }

        .sort-wrapper select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            font-size: 0.938rem;
            background: #fff;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234F46E5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
            color: var(--primary);
        }

        /* Brands Grid (from home.ejs) */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: .5rem;
            margin-top: 2rem;
        }

        .brand-card {
            width: 100%;
        }

        .brand-card-wrapper {
            background: #ffffff;
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: inherit;
            height: 100%;
            position: relative;
            width: 100%;
            min-width: 0;
        }

        .brand-card-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .brand-logo-container {
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            /* padding: 1rem; */
            aspect-ratio: 1/1;
            width: 100%;
        }

        .brand-logo-img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .brand-card-info {
            padding: 0.75rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .brand-card-name {
            font-size: 1rem;
            font-weight: 400;
            color: var(--primary);
            /* text-transform: uppercase; */
            margin-bottom: 0.25rem;
            white-space: normal;
            text-decoration: none;
        }

        .brand-card-categories {
            font-size: 0.813rem;
            font-weight: 600;
            line-height: 1.3;
            color: var(--text-main);
            margin-bottom: 0.75rem;
        }

        .brand-card-actions {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-top: auto;
        }

        .brand-action-mini-btn {
            flex: 1;
            padding: 0.4rem 0.25rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text-main);
            font-size: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.25rem;
            text-decoration: none;
            min-width: 0;
            overflow: hidden;
        }

        @media (max-width: 640px) {
            .brand-action-mini-btn {
                padding: 0.6rem 0.5rem;
                font-size: 0.75rem;
            }
        }

        .brand-action-mini-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(79, 70, 229, 0.02);
        }

        .brand-action-mini-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .brand-action-mini-btn.active {
            background: rgba(79, 70, 229, 0.06);
            border-color: var(--primary);
            color: var(--primary);
        }

        .badge-mini {
            font-size: 0.5rem;
            padding: 1px 3px;
            border-radius: 2px;
            font-weight: 800;
        }

        .badge-sale,
        .badge-code {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .badge-sale {
            background: var(--danger);
            color: white;
        }

        .badge-code {
            background: #22c55e;
            color: white;
        }

        .expanded-section {
            display: none;
            background: #f9fafb;
            border-top: 1px solid var(--border);
            padding: 0.5rem;
            grid-column: 1 / -1;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: .5rem;
            }
        }

        @media (max-width: 500px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .brand-card-wrapper {
                flex-direction: row !important;
                padding: 0.75rem;
                gap: 1rem;
                align-items: center;
                height: auto;
                min-height: 100px;
            }

            .brand-logo-container {
                width: 100px;
                height: 100px;
                aspect-ratio: 1/1 !important;
                flex-shrink: 0;
            }

            .brand-card-info {
                padding: 0;
                flex: 1;
                min-width: 0;
            }

            .brand-card-name {
                font-size: 1rem !important;
                margin-bottom: 0.25rem;
                white-space: normal;
            }

            .brand-card-categories {
                font-size: 0.75rem !important;
                height: auto !important;
                margin-bottom: 0.75rem;
                -webkit-line-clamp: 1;
            }

            .brand-card-actions {
                flex-direction: row;
                gap: 0.5rem;
            }

            .brand-action-mini-btn {
                padding: 0.5rem;
                font-size: 0.7rem;
            }
        }



        .offer-row:hover,
        .prod-card:hover {
            background-color: #f0f9ff !important;
        }

        @media (max-width: 640px) {
            .products-grid {
                gap: 0.5rem !important;
            }

            .brand-card-name {
                font-size: 1rem;
            }
        }

        .prod-search::placeholder,
        .offer-search-input::placeholder {
            color: var(--primary);
            opacity: 1;
        }
    </style>

    <% var allCategories=advertisers.flatMap(a=> a.categories || []).filter(c => c).map(c => c.trim());
        var categories = [...new Set(allCategories)].sort((a, b) => a.localeCompare(b));
        %>

<body>
    <% if (typeof settings !=='undefined' && settings.bgImageUrl) { %>
        <div class="bg-fixed-layer" style="background-image: url('<%= settings.bgImageUrl %>');"></div>
        <% } %>

            <header
                style="<%= (typeof settings !== 'undefined' && settings.headerStyles) ? settings.headerStyles : '' %>">
                <%- include('partials/header', { pageH1: (typeof pageH1 !=='undefined' ? pageH1 : 'Brands' ), settings:
                    (typeof settings !=='undefined' ? settings : {}) }) %>
            </header>

            <div class="container">
                <main>
                    <!-- Filter & Search Section -->
                    <div class="filter-section">
                        <div class="category-links" id="category-links">
                            <a href="javascript:void(0)" class="category-link active-category" data-category="all"
                                onclick="selectCategory('all')">All Categories</a>
                            <% categories.forEach(c=> { %>
                                <a href="javascript:void(0)" class="category-link" data-category="<%= c %>"
                                    onclick="selectCategory('<%= c %>')">
                                    <%= c %>
                                </a>
                                <% }); %>
                        </div>

                        <button id="category-expand-btn" class="category-expand-btn" onclick="toggleCategories()">
                            <span>Show More Categories</span>
                            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <div class="controls-row">
                            <div class="search-wrapper">
                                <span class="search-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </span>
                                <input type="text" id="brand-search" placeholder="Search brands and items..."
                                    oninput="handleSearchInput(this)">
                                <div id="global-search-results" class="global-search-results"></div>
                            </div>

                            <div class="sort-wrapper">
                                <select id="sort-order" onchange="applyFiltersAndSort()">
                                    <option value="name-asc">Brand (A-Z)</option>
                                    <option value="name-desc">Brand (Z-A)</option>
                                    <option value="offers-desc">Top Offers</option>
                                    <option value="products-desc">Most Products</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Brands List -->
                    <div class="products-grid" id="brands-container">
                        <% advertisers.forEach(adv=> { %>
                            <div class="brand-card" data-id="<%= adv.id %>" data-name="<%= adv.name.toLowerCase() %>"
                                data-slug="<%= adv.slug || adv.name.toLowerCase().replace(/\s+/g, '-') %>"
                                data-categories='<%= JSON.stringify(adv.categories || []).toLowerCase() %>'
                                data-offers="<%= adv.offerCount || 0 %>" data-products="<%= adv.productCount || 0 %>">

                                <a href="<%= '/brand/' + adv.id + '-' + (adv.slug || adv.name.toLowerCase().replace(/\s+/g, '-')) %>"
                                    class="brand-card-wrapper">
                                    <div class="brand-logo-container">
                                        <% if (adv.logoUrl) { %>
                                            <img src="<%= adv.logoUrl %>" alt="<%= adv.name %>" class="brand-logo-img">
                                            <% } else { %>
                                                <span
                                                    style="color: #9ca3af; font-size: 2rem; font-weight: 700;">?</span>
                                                <% } %>
                                    </div>

                                    <div class="brand-card-info">
                                        <div class="brand-card-name">
                                            <%= adv.name %>
                                        </div>

                                        <div class="brand-card-categories">
                                            <%= (adv.categories || []).sort().join(', ') %>
                                        </div>

                                        <div class="brand-card-actions">
                                            <button class="brand-action-mini-btn toggle-offers-btn"
                                                data-adv-id="<%= adv.id %>"
                                                onclick="event.preventDefault(); toggleDetails(' <%=adv.id %>',
                                                'offers')"
                                                <%=(adv.offerCount || 0)===0 ? 'disabled' : '' %>>
                                                    <span>
                                                        <%= (adv.offerCount || 0) %> Offers
                                                    </span>
                                                    <% if (adv.hasPromoCodes) { %>
                                                        <span class="badge-code">CODES</span>
                                                        <% } %>
                                                            </button>

                                                            <button class="brand-action-mini-btn toggle-products-btn"
                                                                data-adv-id="<%= adv.id %>"
                                                                onclick="event.preventDefault(); toggleDetails('<%= adv.id %>', 'products')"
                                                                <%=(adv.productCount || 0)===0 ? 'disabled' : '' %>>
                                                                <span>
                                                                    <%= (adv.productCount || 0) %> Products
                                                                </span>
                                                                <% if (adv.saleProductCount> 0) { %>
                                                                    <span class="badge-sale">SALE</span>
                                                                    <% } %>
                                                            </button>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <% }); %>
                    </div>
                </main>
            </div>

            <%- include('partials/footer') %>

                <!-- Home Link Modal (Admin) -->
                <div id="homeLinkModal"
                    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px);">
                    <div
                        style="background: white; padding: 2rem; border-radius: 0.5rem; width: 400px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-main); font-size: 1.125rem;">
                            Enter
                            Homepage Affiliate URL</h3>
                        <input type="text" id="modalHomeLinkInput" placeholder="https://..."
                            style="width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 0.375rem; font-size: 0.95rem;">
                        <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                            <button onclick="closeHomeLinkModal()"
                                style="background: transparent; border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; color: var(--text-main);">Cancel</button>
                            <button id="modalSubmitBtn" onclick="submitHomeLink()"
                                style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500;">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Details Modal (Offers/Products) -->
                <div id="detailsModal"
                    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto;">
                    <div class="modal-inner-p"
                        style="padding: 2rem; position: relative; max-width: 1200px; margin: 0 auto; min-height: 100vh;">
                        <button onclick="closeDetailsModal()" class="modal-close-btn"
                            style="position: fixed; top: 1rem; right: 2rem; background: #fff; border: 1px solid var(--border); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2001; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: var(--text-main);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <div id="detailsModalContent"></div>
                    </div>
                </div>

                <style>
                    @media (max-width: 768px) {
                        .modal-inner-p {
                            padding: 1rem !important;
                            padding-top: 4rem !important;
                        }

                        .modal-close-btn {
                            right: 1rem !important;
                            top: 0.5rem !important;
                        }
                    }
                </style>

                <script>
                    let currentAdvId = null;

                    window.openHomeLinkModal = (advId, currentUrl) => {
                        const modal = document.getElementById('homeLinkModal');
                        const input = document.getElementById('modalHomeLinkInput');
                        if (!modal || !input) return;
                        currentAdvId = advId.trim();
                        input.value = currentUrl;
                        modal.style.display = 'flex';
                        input.focus();
                    };

                    window.closeHomeLinkModal = () => {
                        document.getElementById('homeLinkModal').style.display = 'none';
                        currentAdvId = null;
                    };

                    window.submitHomeLink = async () => {
                        if (!currentAdvId) return;
                        const input = document.getElementById('modalHomeLinkInput');
                        const btn = document.getElementById('modalSubmitBtn');
                        const homeLink = input.value.trim();
                        try {
                            btn.textContent = 'Saving...';
                            btn.disabled = true;
                            const res = await fetch(`/api/advertiser/${currentAdvId}/homelink`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ homeLink })
                            });
                            const data = await res.json();
                            if (data.success) location.reload();
                            else alert('Save failed: ' + data.error);
                        } catch (err) {
                            console.error(err);
                            alert('Error saving home link');
                        } finally {
                            btn.textContent = 'Save';
                            btn.disabled = false;
                        }
                    };

                    const activeStyleSettings = JSON.parse(document.body.dataset.styleSettings || '{}');
                    let currentCategory = 'all';

                    const slugify = (text) => {
                        if (!text) return '';
                        return text.toString().toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^\w\-]+/g, '')
                            .replace(/\-\-+/g, '-')
                            .replace(/^-+/, '')
                            .replace(/-+$/, '');
                    };

                    // Lazy Loading and UI Toggling
                    // Helper functions for rendering
                    const renderOffersTable = (container, offers, advId) => {
                        if (offers.length === 0) {
                            container.innerHTML = '<div style="padding:1rem;">No offers found.</div>';
                            return;
                        }

                        const formatTimeLeft = (endDateStr) => {
                            if (!endDateStr || endDateStr.startsWith('0000-00-00')) return '<span style="color: green;">Never</span>';
                            const end = new Date(endDateStr);
                            if (isNaN(end.getTime())) return '<span style="color: green;">Never</span>';

                            const now = new Date();
                            const diff = end - now;
                            if (diff <= 0) return `<span style="color: red;">Expired (${end.toLocaleDateString()})</span>`;
                            const msPerDay = 86400000;
                            const msPerYear = msPerDay * 365.25;
                            const years = Math.floor(diff / msPerYear);
                            const days = Math.floor((diff % msPerYear) / msPerDay);
                            const hours = Math.floor((diff % msPerDay) / 3600000);
                            let p = [];
                            if (years > 0) p.push(`<b>${years}</b> year${years !== 1 ? 's' : ''}`);
                            if (days > 0 || years > 0) p.push(`<b>${days}</b> day${days !== 1 ? 's' : ''}`);
                            p.push(`<b>${hours}</b> hour${hours !== 1 ? 's' : ''}`);
                            return `<span style="color: ${diff < msPerDay * 7 ? 'red' : 'green'};">${p.join(', ')}</span>`;
                        };

                        const isRealCode = (code) => {
                            if (!code) return false;
                            const clean = String(code).trim().toUpperCase();
                            const nonCodes = [
                                'N/A', 'NONE', 'NO CODE', 'NO CODE REQUIRED', 'NO COUPON CODE', 'NO COUPON CODE REQUIRED',
                                'NO COUPON REQUIRED', 'NO PROMO CODE REQUIRED', 'NO PROMO REQUIRED',
                                'SEE SITE', 'CLICK TO REVEAL', 'AUTO-APPLIED', 'ONLINE ONLY', 'NULL', 'UNDEFINED', '',
                                'NO COUPON CODE NEEDED', 'NO CODE NEEDED', 'NO PROMO CODE NEEDED'
                            ];
                            return !nonCodes.includes(clean);
                        };

                        offers.sort((a, b) => {
                            const codeA = isRealCode(a.code) ? 1 : 0;
                            const codeB = isRealCode(b.code) ? 1 : 0;
                            if (codeA !== codeB) return codeB - codeA;
                            return (a.endDate ? new Date(a.endDate).getTime() : Infinity) - (b.endDate ? new Date(b.endDate).getTime() : Infinity);
                        });

                        let html = `
            <div style="margin-bottom: 1rem;">
                <div style="margin-bottom: 0.75rem;">
                    <strong style="color: var(--text-main);">Active ${offers.length === 1 ? 'Offer' : 'Offers'} (${offers.length})</strong>
                </div>
                <div style="position: relative; width: 100%;">
                    <input type="text" placeholder="Filter offers..." class="offer-search-input" style="padding: 0.625rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border); font-size: 0.875rem; width: 100%; box-sizing: border-box; display: block; color: var(--primary);">
                </div>
            </div>
            <div class="offers-list" style="display: flex; flex-direction: column; gap: 0.75rem;">`;

                        offers.forEach(o => {
                            if (o.endDate && new Date(o.endDate) < new Date()) return;
                            const safeCode = (o.code || '').replace(/'/g, "\\'");
                            const hasCode = isRealCode(o.code);
                            const codeDisplay = hasCode ? `
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
                    <span style="font-family: monospace; padding: 0.375rem 0.75rem; background: #eef2ff; border: 2px dashed #818cf8; border-radius: 0.375rem; color: #4338ca; font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">${o.code}</span>
                    <span style="cursor: pointer; color: var(--text-secondary); font-size: 0.75rem; display: flex; align-items: center; gap: 4px;" onclick="navigator.clipboard.writeText('${safeCode}'); this.lastChild.textContent = ' Copied!'; this.style.color='#10b981'; setTimeout(()=>{this.lastChild.textContent = ' Copy/Redeem'; this.style.color='';}, 2000)">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2" /></svg> Copy/Redeem
                    </span>
                </div>` : `
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
                    <span style="padding: 0.375rem 0.75rem; background: #eef2ff; border: 1px solid #818cf8; border-radius: 0.375rem; color: #4338ca; font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center; gap: 6px;">
                        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                        Redeem
                    </span>
                </div>`;

                            html += `
                <div class="offer-row" style="background: white; border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 1px rgba(0, 0, 0, .25);" onclick="window.open('${o.link}', '_blank')">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex-shrink: 0; opacity: 0.75;">
                            <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="#8b5cf6"><path stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" /></svg>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 1.063rem; color: var(--text-main); word-break: break-word;">${o.description || ''}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Expires: ${formatTimeLeft(o.endDate)}</div>
                            ${codeDisplay}
                        </div>
                    </div>
                </div>`;
                        });
                        html += '</div>';
                        container.innerHTML = html;

                        const input = container.querySelector('.offer-search-input');
                        input.oninput = (e) => {
                            const t = e.target.value.toLowerCase();
                            container.querySelectorAll('.offer-row').forEach(r => {
                                r.style.display = r.innerText.toLowerCase().includes(t) ? 'block' : 'none';
                            });
                        };
                    };

                    // Global Search Logic
                    let searchTimeout = null;
                    window.handleSearchInput = (input) => {
                        const q = input.value.trim();
                        const resultsDiv = document.getElementById('global-search-results');

                        // Always clear existing timeout immediately to stop pending searches
                        clearTimeout(searchTimeout);

                        // Re-run category filtering if needed, but not search filtering
                        applyFiltersAndSort();

                        if (q.length < 1) {
                            resultsDiv.style.display = 'none';
                            resultsDiv.innerHTML = '';
                            return;
                        }

                        // Initial UI: Show matching brands immediately (local)
                        const matchingBrands = [];
                        if (q.length >= 2) {
                            const searchTerm = q.toLowerCase();
                            document.querySelectorAll('.brand-card').forEach(card => {
                                const name = (card.dataset.name || '').toLowerCase();
                                if (name.includes(searchTerm)) {
                                    const logo = card.querySelector('.brand-logo-img');
                                    matchingBrands.push({
                                        id: card.dataset.id,
                                        name: card.querySelector('.brand-card-name').innerText.trim(),
                                        slug: card.dataset.slug,
                                        logoUrl: logo ? logo.src : null
                                    });
                                }
                            });
                        }

                        if (q.length < 2) {
                            resultsDiv.style.display = 'none';
                            return;
                        }

                        searchTimeout = setTimeout(async () => {
                            try {
                                const res = await fetch(`/api/products/search?q=${encodeURIComponent(q)}`);
                                const data = await res.json();
                                if (data.success && input.value.trim().length >= 2) {
                                    renderGlobalSearchResults(data.products, matchingBrands);
                                } else {
                                    resultsDiv.style.display = 'none';
                                }
                            } catch (err) {
                                console.error('Search error:', err);
                            }
                        }, 300);
                    };

                    window.scrollToBrand = (advId) => {
                        const resultsDiv = document.getElementById('global-search-results');
                        resultsDiv.style.display = 'none';

                        const card = document.querySelector(`.brand-card[data-id="${advId}"]`);
                        if (card) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            card.style.transition = 'outline 0.5s';
                            card.style.outline = '3px solid var(--primary)';
                            setTimeout(() => {
                                card.style.outline = '0px solid transparent';
                            }, 2000);
                        }
                    };

                    const renderGlobalSearchResults = (products, brands = []) => {
                        const resultsDiv = document.getElementById('global-search-results');
                        if (products.length === 0 && brands.length === 0) {
                            resultsDiv.style.display = 'none';
                            return;
                        }

                        let html = '';

                        // Brands Section
                        if (brands.length > 0) {
                            html += brands.map(b => `
                        <div class="search-result-item" onclick="location.href='/brand/${b.id}-${b.slug}'">
                            <div class="search-result-thumb" style="display:flex; align-items:center; justify-content:center; background:#f3f4f6;">
                                ${b.logoUrl ? `<img src="${b.logoUrl}" style="max-width:100%; max-height:100%; object-fit:contain;">` : '<span style="font-size:12px; color:#9ca3af;">?</span>'}
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name" style="font-weight: 700; color: var(--primary);">${b.name}</div>
                                <div class="search-result-brand">Brand</div>
                            </div>
                        </div>
                    `).join('');
                        }

                        if (brands.length > 0 && products.length > 0) {
                            html += '<div style="height: 1px; background: var(--border); margin: 4px 0;"></div>';
                        }

                        // Products Section
                        if (products.length > 0) {
                            html += products.map(p => {
                                const brandName = p.advertiserName || 'brand';
                                const brandSlug = brandName.toLowerCase().replace(/\s+/g, '-');
                                const productUrl = `/product/${brandSlug}/${p.slug || (slugify(p.name) + '-' + (p.sku || '').substring(0, 5))}`;
                                return `
                        <div class="search-result-item" onclick="location.href='${productUrl}'">
                            <img src="${p.storageImageUrl || p.imageUrl || ''}" class="search-result-thumb" onerror="this.src='https://placehold.co/40x40?text=?'">
                            <div class="search-result-info">
                                <div class="search-result-name">${p.name}</div>
                                <div class="search-result-brand" style="font-weight: 700; color: var(--primary);">${p.advertiserName || ''}</div>
                            </div>
                        </div>
                    `;
                            }).join('');
                        }

                        resultsDiv.innerHTML = html;
                        resultsDiv.style.display = 'block';
                    };

                    // Close search results when clicking outside
                    document.addEventListener('click', (e) => {
                        const resultsDiv = document.getElementById('global-search-results');
                        const searchInput = document.getElementById('brand-search');
                        if (resultsDiv && !resultsDiv.contains(e.target) && e.target !== searchInput) {
                            resultsDiv.style.display = 'none';
                        }
                    });

                    const productCache = new Map(); // Cache for pre-fetched pages

                    const loadProductsPage = async (advId, page = 1) => {
                        let contentDiv = document.getElementById(`products-content-${advId}`);
                        if (!contentDiv) contentDiv = document.getElementById('modalInnerContent');
                        if (!contentDiv) return;
                        const searchInput = contentDiv.querySelector('.prod-search');
                        const q = searchInput ? searchInput.value.trim() : '';
                        const cacheKey = `${advId}-${page}-${q}`;

                        // Show loading state
                        contentDiv.style.opacity = '0.7';
                        contentDiv.style.transition = 'opacity 0.2s';

                        try {
                            // Check cache first for instant response
                            if (productCache.has(cacheKey)) {
                                const data = productCache.get(cacheKey);
                                renderProductsTable(contentDiv, data.products, advId, data.pagination);
                                contentDiv.style.opacity = '1';
                            } else {
                                const res = await fetch(`/api/advertiser/${advId}/products?page=${page}&limit=100&q=${encodeURIComponent(q)}`);
                                const data = await res.json();
                                if (data.success) {
                                    renderProductsTable(contentDiv, data.products, advId, data.pagination);
                                    productCache.set(cacheKey, data);
                                }
                            }

                            // Pre-fetch next page silently for "Instant" transitions
                            if (page < 10) { // Only pre-fetch first 10 pages for sanity
                                const nextKey = `${advId}-${page + 1}-${q}`;
                                if (!productCache.has(nextKey)) {
                                    fetch(`/api/advertiser/${advId}/products?page=${page + 1}&limit=100&q=${encodeURIComponent(q)}`)
                                        .then(r => r.json())
                                        .then(d => { if (d.success) productCache.set(nextKey, d); });
                                }
                            }
                        } catch (err) {
                            console.error('Pagination error:', err);
                        } finally {
                            contentDiv.style.opacity = '1';
                        }
                    };

                    const renderProductsTable = (container, products, advId, pagination = null) => {
                        const getNum = (v) => v ? parseFloat(String(v).replace(/[^0-9.-]+/g, "")) : 0;
                        let hasSaleItems = false;
                        products.forEach(p => {
                            const pr = getNum(p.price); const s = getNum(p.salePrice);
                            p._isSale = s > 0 && pr > s;
                            p._savings = p._isSale ? (pr - s) : 0;
                            if (p._isSale) hasSaleItems = true;
                        });

                        products.sort((a, b) => b._savings - a._savings || (b.updatedAt || 0) - (a.updatedAt || 0));

                        // Capture current search value and focus state
                        const prevSearch = container.querySelector('.prod-search');
                        const currentSearch = prevSearch ? prevSearch.value : '';
                        const wasFocused = prevSearch === document.activeElement;
                        const brandName = products.length > 0 ? (products[0].advertiserName || '') : '';

                        const getPaginationHtml = (position) => {
                            if (!pagination || pagination.totalPages <= 1) return '';
                            return `
                    <div class="pagination-controls ${position}">
                        <button class="pagination-btn" ${pagination.page <= 1 ? 'disabled' : ''} onclick="loadProductsPage('${advId}', ${pagination.page - 1})">
                            &larr; Prev
                        </button>
                        <span class="pagination-info">Page ${pagination.page} of ${pagination.totalPages}</span>
                        <button class="pagination-btn" ${pagination.page >= pagination.totalPages ? 'disabled' : ''} onclick="loadProductsPage('${advId}', ${pagination.page + 1})">
                            Next &rarr;
                        </button>
                    </div>`;
                        };

                        let html = `
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                    <strong style="color: var(--text-main); white-space: nowrap;">${(pagination ? pagination.total : products.length) === 1 ? 'Product' : 'Products'} (${pagination ? pagination.total : products.length})</strong>
                    ${(hasSaleItems) ? `
                    <label style="display: flex; align-items: center; font-size: 0.813rem; color: var(--danger); cursor: pointer; user-select: none; white-space: nowrap;">
                        <input type="checkbox" class="sale-toggle" checked style="margin-right: 4px;"> On Sale
                    </label>` : ''}
                </div>
                <div style="position: relative; width: 100%;">
                    <input type="text" placeholder="Search ${brandName}..." 
                        class="prod-search" 
                        value="${currentSearch.replace(/"/g, '&quot;')}" 
                        style="padding: 0.625rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border); font-size: 0.875rem; width: 100%; box-sizing: border-box; display: block; color: var(--primary);">
                </div>
            </div>
            ${getPaginationHtml('top')}`;

                        if (products.length === 0) {
                            html += '<div style="padding:4rem 2rem; text-align:center; color:var(--text-secondary); background:var(--bg-main); border-radius:0.75rem; border:1px dashed var(--border);">No products found matching your search.</div>';
                        } else {
                            html += '<div class="prod-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); grid-auto-rows: 1fr; gap: 1rem;">';
                            products.forEach(p => {
                                const price = getNum(p.price); const sale = getNum(p.salePrice);
                                const priceHtml = p._isSale ? `
                    <span style="color: var(--danger); font-weight: 700;">${sale} ${p.currency || ''}</span>
                    <span style="text-decoration: line-through; color: silver; font-size: 0.8em; margin: 0 4px;">${price}</span>
                    <div style="color: var(--success); font-size: 0.75em; font-style: italic; font-weight: 600; margin-top: 2px;">Save ${p._savings.toFixed(2)}!</div>
                ` : `<span style="color: var(--text-main); font-weight: 600;">${p.price || '--'} ${p.currency || ''}</span>`;

                                const brandSlug = brandName.toLowerCase().replace(/\s+/g, '-');
                                const productUrl = `/product/${brandSlug}/${p.slug || (slugify(p.name) + '-' + (p.sku || '').substring(0, 5))}`;

                                html += `
                    <div class="prod-card" data-sale="${p._isSale}" onclick="location.href='${productUrl}'" style="background: white; border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.75rem; display: flex; gap: 1rem; cursor: pointer; transition: background 0.2s, transform 0.2s; box-shadow: 0 1px 1px rgba(0, 0, 0, .25); height: 100%; box-sizing: border-box; position: relative;">
                        ${p._isSale ? `
                        <div style="position: absolute; top: 0; left: 0; background: var(--danger); color: white; padding: 0.25rem 0.625rem; border-radius: 0.75rem 0 0.75rem 0; font-size: 0.688rem; font-weight: 800; z-index: 1; letter-spacing: 0.05em;">SALE</div>
                        ` : ''}
                        <div style="width: 80px; height: 80px; flex-shrink: 0; background: #f9fafb; border-radius: 0.5rem; overflow: hidden; border: 1px solid #eee; position: relative;">
                            <img src="${p.storageImageUrl || p.imageUrl || ''}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.src='https://placehold.co/80x80?text=?'">
                        </div>
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
                            <div style="font-weight: 600; font-size: 0.938rem; color: var(--text-main); line-height: 1.3; margin-bottom: 0.5rem;">${p.name || ''}</div>
                            <div style="margin-top: auto; font-size: 0.875rem; text-align: right; background: linear-gradient(to left, #f8f9fa, transparent); padding: 8px 10px; border-radius: 0.75rem;">${priceHtml}</div>
                        </div>
                    </div>`;
                            });
                            html += '</div>';
                        }

                        // Add bottom pagination controls
                        html += getPaginationHtml('bottom');

                        container.innerHTML = html;

                        const newSearchInput = container.querySelector('.prod-search');
                        if (newSearchInput) {
                            if (wasFocused) {
                                newSearchInput.focus();
                                newSearchInput.setSelectionRange(currentSearch.length, currentSearch.length);
                            }
                            let prodSearchTimeout = null;
                            newSearchInput.oninput = (e) => {
                                clearTimeout(prodSearchTimeout);
                                prodSearchTimeout = setTimeout(() => {
                                    loadProductsPage(advId, 1);
                                }, 400);
                            };
                        }

                        const update = () => {
                            const saleToggle = container.querySelector('.sale-toggle');
                            const saleOn = saleToggle ? saleToggle.checked : true;
                            container.querySelectorAll('.prod-card').forEach(c => {
                                const isSaleItem = c.dataset.sale === 'true';
                                c.style.display = (saleOn || !isSaleItem) ? 'flex' : 'none';
                            });
                        };

                        const saleToggleInput = container.querySelector('.sale-toggle');
                        if (saleToggleInput) saleToggleInput.onchange = update;
                        update();
                    };

                    window.closeDetailsModal = () => {
                        document.getElementById('detailsModal').style.display = 'none';
                        document.body.style.overflow = '';
                    };

                    window.toggleDetails = async (rawId, type) => {
                        const advId = String(rawId).trim();
                        const modal = document.getElementById('detailsModal');
                        const contentDiv = document.getElementById('detailsModalContent');
                        const card = document.querySelector(`.brand-card[data-id="${advId}"]`);
                        const brandName = card ? card.querySelector('.brand-card-name').innerText.trim() : 'Brand';

                        modal.style.display = 'block';
                        document.body.style.overflow = 'hidden';
                        contentDiv.innerHTML = `
                            <div style="margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                                <img src="/placeholder.png" data-src="${card?.querySelector('img')?.src || ''}" 
                                     onerror="this.style.display='none'" 
                                     style="width: 48px; height: 48px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border);"
                                     onload="this.src=this.dataset.src">
                                <h2 style="margin: 0; color: var(--text-main); font-size: 1.5rem;">${brandName} ${type === 'offers' ? 'Offers' : 'Products'}</h2>
                            </div>
                            <div style="text-align: center; color: var(--text-secondary); padding: 4rem;">Loading...</div>
                        `;

                        try {
                            const res = await fetch(`/api/advertiser/${advId}/${type}`);
                            const data = await res.json();

                            if (data.success) {
                                // Clear loading but keep header
                                contentDiv.innerHTML = `
                                    <div style="margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                                        <img src="${card?.querySelector('img')?.src || ''}" 
                                             onerror="this.style.display='none'" 
                                             style="width: 48px; height: 48px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border);">
                                        <h2 style="margin: 0; color: var(--text-main); font-size: 1.5rem;">${brandName} ${type === 'offers' ? 'Offers' : 'Products'}</h2>
                                    </div>
                                    <div id="modalInnerContent"></div>
                                `;
                                const innerContent = document.getElementById('modalInnerContent');
                                if (type === 'offers') renderOffersTable(innerContent, data.offers, advId);
                                else renderProductsTable(innerContent, data.products, advId, data.pagination);
                            } else {
                                contentDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 4rem;">Failed to load data.</div>';
                            }
                        } catch (err) {
                            console.error('Error loading data:', err);
                            contentDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 4rem;">Error loading data.</div>';
                        }
                    };

                    window.toggleCategories = () => {
                        const container = document.getElementById('category-links');
                        const btn = document.getElementById('category-expand-btn');

                        if (container.classList.contains('collapsed')) {
                            // Expand
                            container.classList.remove('collapsed');
                            container.style.maxHeight = container.scrollHeight + "px";
                            btn.querySelector('span').textContent = 'Show Less Categories';
                            btn.querySelector('svg').style.transform = 'rotate(180deg)';
                        } else {
                            // Collapse
                            container.style.maxHeight = "110px"; // Match the CSS collapsed height
                            setTimeout(() => {
                                container.classList.add('collapsed');
                                container.style.maxHeight = ""; // Clear inline style after transition to let CSS take over
                            }, 300); // Wait for transition
                            btn.querySelector('span').textContent = 'Show More Categories';
                            btn.querySelector('svg').style.transform = 'rotate(0deg)';
                        }
                    };

                    // Initialize collapsed state on load if needed (e.g., if many categories)
                    document.addEventListener('DOMContentLoaded', () => {
                        const container = document.getElementById('category-links');
                        if (container.scrollHeight > 120) { // If content is taller than collapsed height
                            container.classList.add('collapsed');
                        } else {
                            // Hide button if no need to expand
                            const btn = document.getElementById('category-expand-btn');
                            if (btn) btn.style.display = 'none';
                        }
                    });

                    // Initialize collapsed state on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('category-links').classList.add('collapsed');
                    }

                    window.selectCategory = (cat) => {
                        currentCategory = cat;
                        document.querySelectorAll('.category-link').forEach(link => {
                            link.classList.toggle('active-category', link.dataset.category === cat);
                        });
                        applyFiltersAndSort();
                    };

                    window.applyFiltersAndSort = () => {
                        const container = document.getElementById('brands-container');
                        const searchTerm = document.getElementById('brand-search').value.toLowerCase();
                        const sortOrder = document.getElementById('sort-order').value;
                        const cards = Array.from(document.querySelectorAll('.brand-card'));

                        // Filter
                        cards.forEach(card => {
                            const cats = JSON.parse(card.dataset.categories);
                            const matchesCategory = currentCategory === 'all' || cats.includes(currentCategory.toLowerCase());
                            card.style.display = matchesCategory ? 'block' : 'none';
                        });

                        cards.sort((a, b) => {
                            const nameA = a.dataset.name;
                            const nameB = b.dataset.name;
                            const offersA = parseInt(a.dataset.offers);
                            const offersB = parseInt(b.dataset.offers);
                            const productsA = parseInt(a.dataset.products);
                            const productsB = parseInt(b.dataset.products);

                            switch (sortOrder) {
                                case 'name-asc': return nameA.localeCompare(nameB);
                                case 'name-desc': return nameB.localeCompare(nameA);
                                case 'offers-desc': return offersB - offersA || nameA.localeCompare(nameB);
                                case 'products-desc': return productsB - productsA || nameA.localeCompare(nameB);
                                default: return 0;
                            }
                        });

                        cards.forEach(card => container.appendChild(card));
                    };
                </script>
                <%- include('partials/nav-scripts') %>
                    <script>
                        window.applyFiltersAndSort();
                    </script>
</body>

</html>